# Weighty Containers

**Foundry VTT Module for Dungeons & Dragons 5th Edition**

## Обзор

Этот модуль расширяет функциональность предметов-контейнеров в системе D&D 5e для Foundry VTT. Он добавляет реалистичное отслеживание веса содержимого, возможность для контейнеров "магически" снижать вес находящихся в них предметов **и валюты**, а также корректно отображает итоговую нагрузку на листе персонажа и листах контейнеров.

## Основные Возможности

*   **Лимит Вместимости по Весу:** Модуль строго следит за максимальным весом, который может вместить контейнер (если он настроен на ограничение по весу). Попытки добавить предметы, превышающие лимит (с учетом *эффективного* веса предметов **и** *эффективного* веса **всей валюты** персонажа, если контейнер ее "облегчает"), будут заблокированы.
*   **Процентное Снижение Веса:**
    *   **Предметы:** Позволяет устанавливать для каждого контейнера индивидуальный процент (от 0% до 100%), на который снижается вес *всех* предметов, находящихся внутри него.
    *   **Валюта:** Позволяет указать для каждого контейнера, влияет ли он на вес валюты. Если хотя бы один такой контейнер есть у персонажа, к **общему весу валюты** применяется *лучший* процент снижения среди всех таких контейнеров.
*   **Динамический Вес:** Снижение веса предметов применяется только пока предмет находится *внутри* контейнера. Как только предмет извлекается, его вес возвращается к базовому значению. Снижение веса валюты зависит от наличия соответствующих контейнеров у персонажа.
*   **Интерфейс на Листе Контейнера:**
    *   Отображает текущий процент снижения веса для *предметов* в шапке листа контейнера.
    *   Цвет индикатора процента соответствует "редкости" или силе снижения.
    *   Добавляет кнопку <i class="fas fa-cogs"></i> для быстрой настройки процента снижения веса предметов.
    *   Добавляет чекбокс на вкладке "Details" для включения/выключения снижения веса *валюты* этим контейнером.
*   **Корректное Отображение Нагрузки:**
    *   **Общий вес персонажа (Encumbrance):** На листе персонажа теперь учитывает *эффективный* вес предметов (с учетом скидок в контейнерах) **и** *эффективный* вес валюты (с учетом лучшей скидки).
    *   **Вес на Листе Контейнера:** На вкладке "Contents" отображаемый вес и полоска загрузки показывают **сумму** *эффективного веса предметов* внутри контейнера **плюс** *эффективный вес всей валюты* персонажа (если хотя бы один контейнер у актора снижает вес валюты). Это отражает общий вклад содержимого и валюты в занимаемое "место" относительно лимита контейнера.
    *   **Вес Отдельного Предмета:** На листе актора (инвентарь) рядом с базовым весом предмета, находящегося в контейнере со скидкой, в скобках показан его *эффективный* вес.
*   **Настройки Модуля:**
    *   Опция для ограничения доступа к кнопке настройки процента снижения веса только для GM.
    *   Возможность задать собственный текст уведомления о превышении лимита веса контейнера.
*   **Совместимость:**
    *   Должен быть совместим с модулем `rarity-colors`.
    *   Интеграция с Item Piles **удалена** из-за нестабильности API хуков. Проверка веса при операциях через Item Piles работать не будет.

## Установка

1.  **Через Манифест (Рекомендуется):**
    *   В меню настройки Foundry VTT перейдите на вкладку "Add-on Modules".
    *   Нажмите "Install Module".
    *   В поле "Manifest URL" вставьте ссылку на `module.json` этого модуля.
    *   Нажмите "Install".
2.  **Вручную:**
    *   Скачайте zip-архив модуля.
    *   Распакуйте его в папку `Data/modules/weighty-containers/` в вашей директории пользователя Foundry VTT.
    *   Перезапустите Foundry VTT.

После установки не забудьте активировать модуль "Weighty Containers" в настройках вашего мира.

## Использование и Настройка

1.  **Настройка Контейнера:**
    *   Откройте лист настроек контейнера (из Items Directory).
    *   Вкладка **"Details"**.
    *   **"Capacity Type"** = **"Weight"**.
    *   **"Max Weight"** = Установите числовое значение (больше 0).
    *   Сохраните.
2.  **Настройка Снижения Веса Предметов:**
    *   Откройте лист контейнера **из инвентаря актора**.
    *   Нажмите на иконку шестеренки <i class="fas fa-cogs"></i> в шапке.
    *   Введите процент (0-100), сохраните.
3.  **Настройка Снижения Веса Валюты:**
    *   Откройте лист контейнера.
    *   Вкладка **"Details"**.
    *   Отметьте чекбокс **"Снижает вес валюты"** ("Reduces Currency Weight").
    *   Скидка к весу валюты будет применяться на основе *максимального* процента, установленного для *предметов* на всех контейнерах с этим включенным флагом, которые несет персонаж.
4.  **Проверка Лимита:**
    *   При добавлении/изменении количества предмета в контейнер, модуль проверит: `(Эффективный вес предметов в контейнере + Эффективный вес ВСЕЙ валюты актора) + Эффективный вес добавляемого предмета <= Лимит контейнера`.
    *   Если лимит превышен, операция блокируется.
5.  **Отображение Веса:**
    *   **Лист контейнера:** Показывает `(Эфф. вес предметов + Эфф. вес валюты) / Лимит`.
    *   **Лист актора (Общая загрузка):** Показывает `(Сумма эфф. веса всех предметов + Эфф. вес валюты) / Макс. нагрузка актора`.
    *   **Лист актора (Предмет):** Показывает базовый вес и `(Эффективный вес: X)` в скобках, если вес снижен.
6.  **Настройки Модуля:**
    *   Меню "Configure Settings" -> "Module Settings" -> "Weighty Containers".
    *   Настройте доступ GM к кнопке и текст уведомления.

## Совместимость

*   **Foundry VTT:** v12.324+ (проверено на v12.331)
*   **D&D 5e System:** v3.2.0+ (проверено на v4.3.9)
*   **libWrapper:** **Рекомендуется** для надежного патчинга расчета загрузки актора.
*   **Rarity Colors:** Совместим.
*   **Item Piles:** **Не поддерживается** проверка лимита при операциях через Item Piles. Используйте стандартные методы перемещения предметов.
*   **Другие Модули Листов:** UI модуля и отображение веса на листе контейнера могут не работать с сильно кастомизированными листами.

## Лицензия

MIT

## Автор

TacticalOtaku